<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script> 
    <script src="http://code.jquery.com/jquery-3.2.1.min.js"></script>      
    <title>PoseNetを用いた静止画の姿勢推定</title>
    <script>
        //画像描画関数
        function drawImage(imageFile) {
            let canvas = $("#preview");
            let ctx = canvas[0].getContext("2d");
            //イメージオブジェクト
            let img1 = new Image();
            //画像ファイル指定でファイル読込開始
            img1.src = imageFile;
            //画像ロード後に画像を描画できる。
            img1.onload = function () {
                //画像の大きさを設定
                width = img1.width;
                height = img1.height;
                canvas.attr('width', width);
                canvas.attr('height', height);
                //画像を描画
                ctx.drawImage(img1, 0, 0, width, height);
            }
            return false;
        }
        //矩形描画関数
        function drawRect_h(x, y) {
            let canvas = $("#preview");
            let ctx = canvas[0].getContext("2d");
            // 青線の描画準備
            ctx.lineWidth = 3;
            ctx.strokeStyle = "rgb(0, 255, 0)";
            ctx.strokeRect(x, y, 5, 5);
            return false;
        }
        function drawRect_f(x, y) {
            let canvas = $("#preview");
            let ctx = canvas[0].getContext("2d");
            // 青線の描画準備
            ctx.lineWidth = 3;
            ctx.strokeStyle = "rgb(0, 0, 255)";
            ctx.strokeRect(x, y, 5, 5);
            return false;
        }
        $(document).ready(function (e) {
            let file = null;// 選択された画像ファイル格納場所
            // change：画像が変更されると実行
            $("#image_data").change(function () {
                // ファイルの取得
                file = $(this).prop("files")[0];
                let fileReader = new FileReader();
                // 選択されたファイルを表示、PoseNetで姿勢推定
                fileReader.onload = (function (e) {
                    //画像表示関数の呼び出し
                    drawImage(e.target.result);
                    // 姿勢推定：左手首のx座標などを表示
                    posenet.load().then(function (net) {
                        // PoseNetに画像を送り、画像認識結果を得る
                        // 得られた結果はposeに格納されている
                        return net.estimateSinglePose($("#preview")[0], 0.5, false, 16)
                    }).then(function (pose) {
                        console.log(pose);
                        // 左手首のx座標などを<p>タグの値に追記
                        $("#left_wrist")[0].innerHTML = "左手首の(x,y)座標：("
                            + pose.keypoints[9].position.x.toFixed(1).toString() + ", "
                            + pose.keypoints[9].position.y.toFixed(1).toString() + ")";
                        $("#left_shoulder")[0].innerHTML = "左肩の(x,y)座標：("
                            + pose.keypoints[5].position.x.toFixed(1).toString() + ", "
                            + pose.keypoints[5].position.y.toFixed(1).toString() + ")";
                        $("#nose")[0].innerHTML = "鼻の(x,y)座標：("
                            + pose.keypoints[0].position.x.toFixed(1).toString() + ", "
                            + pose.keypoints[0].position.y.toFixed(1).toString() + ")";
                        $("#right_shoulder")[0].innerHTML = "右肩の(x,y)座標：("
                            + pose.keypoints[6].position.x.toFixed(1).toString() + ", "
                            + pose.keypoints[6].position.y.toFixed(1).toString() + ")";
                        $("#right_wrist")[0].innerHTML = "右手首の(x,y)座標：("
                            + pose.keypoints[10].position.x.toFixed(1).toString() + ", "
                            + pose.keypoints[10].position.y.toFixed(1).toString() + ")";
                        $("#left_ankle")[0].innerHTML = "左足首の(x,y)座標：("
                            + pose.keypoints[15].position.x.toFixed(1).toString() + ", "
                            + pose.keypoints[15].position.y.toFixed(1).toString() + ")";
                        $("#right_ankle")[0].innerHTML = "右足首の(x,y)座標：("
                            + pose.keypoints[16].position.x.toFixed(1).toString() + ", "
                            + pose.keypoints[16].position.y.toFixed(1).toString() + ")";
                        $("#left_angle")[0].innerHTML = "手首と肩の角度（左）：("
                            + Math.abs((Math.atan2(pose.keypoints[9].position.y - pose.keypoints[5].position.y, pose.keypoints[9].position.x - pose.keypoints[5].position.x) * 180 / Math.PI)).toFixed(2).toString() + ")";
                        $("#right_angle")[0].innerHTML = "手首と肩の角度（右）：("
                            + Math.abs((Math.atan2(pose.keypoints[6].position.y - pose.keypoints[10].position.y, pose.keypoints[6].position.x - pose.keypoints[10].position.x) * 180 / Math.PI)).toFixed(2).toString() + ")";
                        $("#shoulder_width")[0].innerHTML = "肩幅：("
                            + Math.sqrt((pose.keypoints[6].position.x - pose.keypoints[5].position.x) * (pose.keypoints[6].position.x - pose.keypoints[5].position.x)
                            + (pose.keypoints[6].position.y - pose.keypoints[5].position.y) * (pose.keypoints[6].position.y - pose.keypoints[5].position.y)).toFixed(1).toString() + ')';
                        $("#left_arm_length")[0].innerHTML = "左腕の長さ：("
                            + Math.sqrt((pose.keypoints[9].position.x - pose.keypoints[5].position.x) * (pose.keypoints[9].position.x - pose.keypoints[5].position.x)
                            + (pose.keypoints[9].position.y - pose.keypoints[5].position.y) * (pose.keypoints[9].position.y - pose.keypoints[5].position.y)).toFixed(1).toString() + ")";
                        $("#right_arm_length")[0].innerHTML = "右腕の長さ：("
                            + Math.sqrt((pose.keypoints[10].position.x - pose.keypoints[6].position.x) * (pose.keypoints[10].position.x - pose.keypoints[6].position.x)
                            + (pose.keypoints[10].position.y - pose.keypoints[6].position.y) * (pose.keypoints[10].position.y - pose.keypoints[6].position.y)).toFixed(1).toString() + ")";
                        $("#shoulder_center")[0].innerHTML = "肩の中心の(x,y)座標：("
                            + ((pose.keypoints[6].position.x + pose.keypoints[5].position.x)/2).toFixed(1).toString() + ", "
                            + ((pose.keypoints[6].position.y + pose.keypoints[5].position.y)/2).toFixed(1).toString() + ")";
                        let left_wrist_x = Math.round(parseInt(pose.keypoints[9].position.x));
                        let left_wrist_y = Math.round(parseInt(pose.keypoints[9].position.y));
                        let left_shoulder_x = Math.round(parseInt(pose.keypoints[5].position.x));
                        let left_shoulder_y = Math.round(parseInt(pose.keypoints[5].position.y));
                        let left_ankle_x = Math.round(parseInt(pose.keypoints[15].position.x));
                        let left_ankle_y = Math.round(parseInt(pose.keypoints[15].position.y));
                        let right_wrist_x = Math.round(parseInt(pose.keypoints[10].position.x));
                        let right_wrist_y = Math.round(parseInt(pose.keypoints[10].position.y));
                        let right_shoulder_x = Math.round(parseInt(pose.keypoints[6].position.x));
                        let right_shoulder_y = Math.round(parseInt(pose.keypoints[6].position.y));
                        let right_ankle_x = Math.round(parseInt(pose.keypoints[16].position.x));
                        let right_ankle_y = Math.round(parseInt(pose.keypoints[16].position.y));
                        let nose_x = Math.round(parseInt(pose.keypoints[0].position.x));
                        let nose_y = Math.round(parseInt(pose.keypoints[0].position.y));
                        let right_elbow_x = Math.round(parseInt(pose.keypoints[8].position.x));
                        let right_elbow_y = Math.round(parseInt(pose.keypoints[8].position.y));
                        let left_elbow_x = Math.round(parseInt(pose.keypoints[7].position.x));
                        let left_elbow_y = Math.round(parseInt(pose.keypoints[7].position.y));
                        let right_hip_x = Math.round(parseInt(pose.keypoints[12].position.x));
                        let right_hip_y = Math.round(parseInt(pose.keypoints[12].position.y));
                        let left_hip_x = Math.round(parseInt(pose.keypoints[11].position.x));
                        let left_hip_y = Math.round(parseInt(pose.keypoints[11].position.y));
                        let right_knee_x = Math.round(parseInt(pose.keypoints[14].position.x));
                        let right_knee_y = Math.round(parseInt(pose.keypoints[14].position.y));
                        let left_knee_x = Math.round(parseInt(pose.keypoints[13].position.x));
                        let left_knee_y = Math.round(parseInt(pose.keypoints[13].position.y));
                        let center_x = Math.round(parseInt((pose.keypoints[5].position.x + pose.keypoints[6].position.x) / 2));
                        let center_y = Math.round(parseInt((pose.keypoints[5].position.y + pose.keypoints[6].position.y) / 2));
                        drawRect_h(left_wrist_x, left_wrist_y);
                        drawRect_h(left_shoulder_x, left_shoulder_y);
                        drawRect_f(left_ankle_x, left_ankle_y);
                        drawRect_h(left_elbow_x, left_elbow_y);
                        drawRect_f(left_hip_x, left_hip_y);
                        drawRect_f(left_knee_x, left_knee_y);
                        // drawRect(center_x, center_y);
                        drawRect_h(right_wrist_x, right_wrist_y);
                        drawRect_h(right_shoulder_x, right_shoulder_y);
                        drawRect_f(right_ankle_x, right_ankle_y);
                        drawRect_h(right_elbow_x, right_elbow_y);
                        drawRect_f(right_hip_x, right_hip_y);
                        drawRect_f(right_knee_x, right_knee_y);
                        // drawRect(nose_x, nose_y);
                        console.log("Complete!!");
                    });
                });
            // ローカルフォルダから画像ファイルが読み込まれる
            fileReader.readAsDataURL(file);
        
        });
    });
    </script>
</head>
<body>
    <h3>PoseNetによって検出した体の部位にマーカー表示</h3>
    <!-- ファイル選択ボタン -->
    <p><input type="file" id="image_data"></p>
    <!-- 写真表示領域 -->
    <canvas id="preview" height="320" width="240" style="background-color:black;">
    </canvas>
    <table border="0">
        <tr>
            <td align="left" valign="top" width="50%">
                <div id="parts1">
                    <p id="left_shoulder"></p>
                    <!-- <p id="right_shoulder"></p> -->
                    <p id="left_wrist"></p>
                    <!-- <p id="right_wrist"></p> -->
                    <p id="left_angle"></p>
                    <!-- <p id="right_angle"></p> -->
                    <!-- <p id="nose"></p> -->
                    <p id="left_ankle"></p>
                    <!-- <p id="right_ankle"></p> -->
                    <!-- <p id="left_arm_length"></p> -->
                    <p id="right_arm_length"></p>
                    <p id="shoulder_width"></p>
                    <p id="shoulder_center"></p>
                </div>
            </td>
            <td align="left" valign="top" width="50%">
                <div id="parts2">
                    <!-- <p id="left_shoulder"></p> -->
                    <p id="right_shoulder"></p>
                    <!-- <p id="left_wrist"></p> -->
                    <p id="right_wrist"></p>
                    <!-- <p id="left_angle"></p> -->
                    <p id="right_angle"></p>
                    <!-- <p id="shoulder_center"></p> -->
                    <p id="right_ankle"></p>
                    <!-- <p id="left_ankle"></p> -->
                    <p id="nose"></p>
                    <!-- <p id="shoulder_width"></p> -->
                    <p id="left_arm_length"></p>
                    <!-- <p id="right_arm_length"></p> -->
                </div>
            </td>
        </tr>
    </table>
</body>
</html>